SELECT date_entered, date_modified, next_refill, risklvl_c,  FROM ( SELECT  ENC_ID, next_rx_refill_due_c next_refill, risklvl_c FROM ( SELECT reg_patient_reg_encounterreg_patient_ida PAT_ID, reg_patient_reg_encounterreg_encounter_idb ENC_ID FROM reg_patient_reg_encounter_c WHERE reg_patient_reg_encounterreg_patient_ida = '$id_pat') PAT_ENC_REL, reg_encounter_cstm 

WHERE reg_encounter_cstm.ID_C = PAT_ENC_REL.ENC_ID ) PAT_ENC_REL1, reg_encounter WHERE PAT_ENC_REL1.ENC_ID = reg_encounter.id AND next_refill IS NOT NULL 
AND DATE_ENTERED =  (SELECT MAX(DATE_ENTERED) FROM (SELECT reg_patient_reg_encounterreg_encounter_idb ENC_ID FROM reg_patient_reg_encounter_c WHERE reg_patient_reg_encounterreg_patient_ida = '$id_pat') inner_tbl1 , reg_encounter WHERE inner_tbl1.ENC_ID = reg_encounter.id)


/* get max data by patient */
SELECT max(date_modified), reg_patient_reg_encounterreg_patient_ida from reg_patient_reg_encounter_c group by reg_patient_reg_encounterreg_patient_ida;

/* get patient and encounter details by selecting encounters for each unique patient with max date*/


SELECT *
FROM reg_patient_reg_encounter_c tab1, (

SELECT max( date_modified ) dat, reg_patient_reg_encounterreg_patient_ida pat
FROM reg_patient_reg_encounter_c
GROUP BY reg_patient_reg_encounterreg_patient_ida
)tab2
WHERE tab1.date_modified = tab2.dat
AND tab1.reg_patient_reg_encounterreg_patient_ida = tab2.pat;


/* get custom attributes */

SELECT *
FROM reg_patient_reg_encounter_c tab1, (

SELECT max( date_modified ) dat, reg_patient_reg_encounterreg_patient_ida pat
FROM reg_patient_reg_encounter_c
GROUP BY reg_patient_reg_encounterreg_patient_ida
) tab2,
reg_encounter_cstm tab3
WHERE tab1.date_modified = tab2.dat
AND tab1.reg_patient_reg_encounterreg_patient_ida = tab2.pat
AND tab3.id_c = tab1.reg_patient_reg_encounterreg_encounter_idb;

/* get patient data */
SELECT *
FROM reg_patient_reg_encounter_c tab1, (

SELECT max( date_modified ) dat, reg_patient_reg_encounterreg_patient_ida pat
FROM reg_patient_reg_encounter_c
GROUP BY reg_patient_reg_encounterreg_patient_ida
) tab2,
reg_encounter_cstm tab3,
reg_patient tab4
WHERE tab1.date_modified = tab2.dat
AND tab1.reg_patient_reg_encounterreg_patient_ida = tab2.pat
AND tab3.id_c = tab1.reg_patient_reg_encounterreg_encounter_idb
and tab4.id = tab2.pat;





/* get specific fields*/
SELECT tab4.first_name fname, tab4.last_name lname, tab1.date_modified, tab3.next_rx_refill_due_c refill, tab2.pat patid
FROM reg_patient_reg_encounter_c tab1, (

SELECT max( date_modified ) dat, reg_patient_reg_encounterreg_patient_ida pat
FROM reg_patient_reg_encounter_c
GROUP BY reg_patient_reg_encounterreg_patient_ida
) tab2,
reg_encounter_cstm tab3,
reg_patient tab4
WHERE tab1.date_modified = tab2.dat
AND tab1.reg_patient_reg_encounterreg_patient_ida = tab2.pat
AND tab3.id_c = tab1.reg_patient_reg_encounterreg_encounter_idb
and tab4.id = tab2.pat;


/**** weith provider ****/
SELECT tab4.first_name fname, tab4.last_name lname, tab1.date_modified, tab3.next_rx_refill_due_c refill, tab2.pat patid, tab5.provname provname
FROM reg_patient_reg_encounter_c tab1, (

SELECT max( date_modified ) dat, reg_patient_reg_encounterreg_patient_ida pat
FROM reg_patient_reg_encounter_c
GROUP BY reg_patient_reg_encounterreg_patient_ida
) tab2,
reg_encounter_cstm tab3,
reg_patient tab4,
(SELECT p1.name provname, p1.id  provid, p2.reg_provider_reg_patientreg_patient_idb  provpatid from reg_provider p1, reg_provider_reg_patient_c p2 
 WHERE p2.reg_provider_reg_patientreg_provider_ida = p1.id ) tab5
WHERE tab1.date_modified = tab2.dat
AND tab1.reg_patient_reg_encounterreg_patient_ida = tab2.pat
AND tab3.id_c = tab1.reg_patient_reg_encounterreg_encounter_idb
AND tab4.id = tab2.pat AND tab5.provpatid = tab4.id;

/*** better woith provider ***/

SELECT tab4.first_name fname, tab4.last_name lname, tab1.date_modified, tab3.next_rx_refill_due_c refill, tab2.pat patid, tab5.provname provname,
(SELECT  p2a.reg_provider_reg_patientreg_provider_ida p2aid from reg_provider_reg_patient_c p2a WHERE p2a.reg_provider_reg_patientreg_patient_idb =patid) cassel
FROM reg_patient_reg_encounter_c tab1, (

SELECT max( date_modified ) dat, reg_patient_reg_encounterreg_patient_ida pat
FROM reg_patient_reg_encounter_c
GROUP BY reg_patient_reg_encounterreg_patient_ida
) tab2,
reg_encounter_cstm tab3,
reg_patient tab4,
(SELECT p1.name provname, p1.id  provid, p2.reg_provider_reg_patientreg_patient_idb  provpatid from reg_provider p1, reg_provider_reg_patient_c p2 
 WHERE p2.reg_provider_reg_patientreg_provider_ida = p1.id ) tab5
WHERE tab1.date_modified = tab2.dat
AND tab1.reg_patient_reg_encounterreg_patient_ida = tab2.pat
AND tab3.id_c = tab1.reg_patient_reg_encounterreg_encounter_idb
AND tab4.id = tab2.pat AND tab5.provpatid = tab4.id;


/**** THE BEST BESTESTSTS *** no need for inner join lol **/
SELECT tab1.reg_patient_reg_encounterreg_encounter_idb enclink, tab4.first_name fname, tab4.last_name lname, tab3.next_rx_refill_due_c refill, tab4.id patid,
( SELECT max( date_modified ) dat FROM reg_patient_reg_encounter_c enc1 WHERE  enc1.reg_patient_reg_encounterreg_patient_ida = patid )  maxdate,
( SELECT tab3.next_rx_refill_due_c FROM reg_encounter_cstm tab3 where tab3.id_c = enclink)  refill1, 
(SELECT tab5.mrn_c FROM reg_patient_cstm tab5 where tab5.id_c = patid) mrn,
(SELECT p1b.name provname  from reg_provider p1b, reg_provider_reg_patient_c p2b  WHERE p2b.reg_provider_reg_patientreg_provider_ida = p1b.id  AND p2b.reg_provider_reg_patientreg_patient_idb = patid) provname
FROM reg_patient_reg_encounter_c tab1, 
	reg_encounter_cstm tab3,
	reg_patient tab4
WHERE tab1.reg_patient_reg_encounterreg_patient_ida = tab4.id
AND tab3.id_c = tab1.reg_patient_reg_encounterreg_encounter_idb



/* get all patients including those without encounters yet */
SELECT tab4.first_name fname, tab4.last_name lname, tab1.date_modified datemod, tab3.next_rx_refill_due_c refill, tab2.pat patid, tab5.mrn_c mrn FROM reg_patient_reg_encounter_c tab1,  ( SELECT max( date_modified ) dat, reg_patient_reg_encounterreg_patient_ida pat FROM reg_patient_reg_encounter_c GROUP BY reg_patient_reg_encounterreg_patient_ida) tab2, reg_encounter_cstm tab3, reg_patient tab4, reg_patient_cstm tab5 WHERE tab1.date_modified = tab2.dat AND tab1.reg_patient_reg_encounterreg_patient_ida = tab2.pat AND tab3.id_c = tab1.reg_patient_reg_encounterreg_encounter_idb AND tab4.id = tab2.pat AND tab5.id_c = tab4.id

UNION  

SELECT tab4a.first_name fname, tab4a.last_name lname, null datemod, null refill, tab4a.id patid, tab5a.mrn_c mrn FROM
reg_patient  tab4a , reg_patient_cstm tab5a
where tab4a.id not in (select  reg_patient_reg_encounterreg_patient_ida pat FROM reg_patient_reg_encounter_c )
and tab4a.id = tab5a.id_c;




/* simplest query no union needed */
SELECT tab4.first_name fname, tab4.last_name lname, tab4.id patid,
(SELECT  p2a.reg_provider_reg_patientreg_provider_ida p2aid from reg_provider_reg_patient_c p2a WHERE p2a.reg_provider_reg_patientreg_patient_idb =patid) provid,
(SELECT p1b.name provname  from reg_provider p1b, reg_provider_reg_patient_c p2b  WHERE p2b.reg_provider_reg_patientreg_provider_ida = p1b.id  AND p2b.reg_provider_reg_patientreg_patient_idb = patid) provider,
( SELECT max( date_modified ) dat FROM reg_patient_reg_encounter_c enc1 WHERE  enc1.reg_patient_reg_encounterreg_patient_ida = patid  )  maxdate

FROM 
reg_patient tab4;

/* USE this 10/04*/
SELECT tab4.first_name fname, tab4.last_name lname, tab4.id patid,
(SELECT  p2a.reg_provider_reg_patientreg_provider_ida p2aid from reg_provider_reg_patient_c p2a WHERE p2a.reg_provider_reg_patientreg_patient_idb =patid) provid,
(SELECT p1b.name provname  from reg_provider p1b, reg_provider_reg_patient_c p2b  WHERE p2b.reg_provider_reg_patientreg_provider_ida = p1b.id  AND p2b.reg_provider_reg_patientreg_patient_idb = patid) provider,
( SELECT tab1.reg_patient_reg_encounterreg_encounter_idb enclink  FROM reg_patient_reg_encounter_c tab1 WHERE  tab1.reg_patient_reg_encounterreg_patient_ida = patid AND 
    tab1.date_modified = (SELECT max( date_modified ) dat FROM reg_patient_reg_encounter_c enc1 WHERE  enc1.reg_patient_reg_encounterreg_patient_ida = patid) )  enclink,
( SELECT tab3.next_rx_refill_due_c FROM reg_encounter_cstm tab3 where tab3.id_c = enclink)  refill1, 
(SELECT tab5.mrn_c FROM reg_patient_cstm tab5 where tab5.id_c = patid) mrn,
(SELECT p1b.name provname  from reg_provider p1b, reg_provider_reg_patient_c p2b  WHERE p2b.reg_provider_reg_patientreg_provider_ida = p1b.id  AND p2b.reg_provider_reg_patientreg_patient_idb = patid) provname
FROM 
reg_patient tab4;


/*** no good **/

SELECT tab4.first_name fname, tab4.last_name lname, tab4.id patid,
(SELECT  p2a.reg_provider_reg_patientreg_provider_ida p2aid from reg_provider_reg_patient_c p2a WHERE p2a.reg_provider_reg_patientreg_patient_idb =patid) provid,
(SELECT p1b.name provname  from reg_provider p1b, reg_provider_reg_patient_c p2b  WHERE p2b.reg_provider_reg_patientreg_provider_ida = p1b.id  AND p2b.reg_provider_reg_patientreg_patient_idb = patid) provider,
( SELECT tab1.reg_patient_reg_encounterreg_encounter_idb enclink  FROM reg_patient_reg_encounter_c tab1 WHERE  tab1.reg_patient_reg_encounterreg_patient_ida = patid )  enclink,
( SELECT tab3.next_rx_refill_due_c FROM reg_encounter_cstm tab3 where tab3.id_c = enclink)  refill1, 
(SELECT tab5.mrn_c FROM reg_patient_cstm tab5 where tab5.id_c = patid) mrn,
(SELECT p1b.name provname  from reg_provider p1b, reg_provider_reg_patient_c p2b  WHERE p2b.reg_provider_reg_patientreg_provider_ida = p1b.id  AND p2b.reg_provider_reg_patientreg_patient_idb = patid) provname
FROM 
reg_patient tab4;